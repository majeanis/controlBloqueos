<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cl.cerrocolorado.recob.po.map.RecobMap">

    <resultMap id="estacionMap" type="EstacionTO" >
        <id property="id" column="estc_id" />
        <result property="nombre" column="estc_nomb" />
        <result property="vigente" column="estc_vige" />
    </resultMap>

    <resultMap id="ubicacionMap" type="UbicacionTO" >
        <id property="id" column="ubic_id" />
        <result property="nombre" column="ubic_nomb" />
        <result property="descripcion" column="ubic_desc" />
        <result property="vigente" column="ubic_vige" />
        <result property="token" column="tokn_id" />
        <association property="estacion" resultMap="estacionMap" />
    </resultMap>

    <resultMap id="cajaBloqueoMap" type="CajaBloqueoTO" >
        <id property="id" column="cabl_id" />
        <result property="numero" column="cabl_nume" />
        <result property="nombre" column="cabl_nomb" />
        <result property="vigente" column="cabl_vige" />
        <association property="ubicacion" resultMap="ubicacionMap" />
    </resultMap> 

    <resultMap id="usoCandadoMap" type="UsoCandadoTO" >
        <id property="id" column="dval_id" />
        <result property="codigo" column="dval_codi" />
        <result property="nombre" column="dval_nomb" />
        <result property="vigente" column="dval_vige" />
    </resultMap>
    
    <resultMap id="personaMap" type="PersonaTO" >
        <id property="id" column="pers_id" />
        <result property="rut" column="pers_rut" typeHandler="RutTypeHandler" />
        <result property="nombre" column="pers_nomb"/>
    </resultMap>

    <resultMap id="empresaMap" type="EmpresaTO" >
        <id property="id" column="empr_id" />
        <result property="rut" column="empr_rut" typeHandler="RutTypeHandler" />
        <result property="nombre" column="empr_nomb" />
        <result property="vigente" column="empr_vige" />
    </resultMap>

    <resultMap id="trabajadorMap" type="TrabajadorTO" >
        <result property="id" column="trab_id" />
        <result property="rut" column="trab_rut" typeHandler="RutTypeHandler" /> 
        <result property="nombre" column="trab_nomb" />
        <result property="cargo" column="trab_carg" />
        <result property="tieneCursoBloqueo" column="trab_curs_bloq" />
        <result property="vigente" column="trab_vige" />
        <association property="empresa" resultMap="empresaMap" />
    </resultMap>
    
    <resultMap id="candadoMap" type="CandadoTO" >
        <id property="id" column="cand_id" />
        <result property="numero" column="cand_nume" />
        <result property="serie" column="cand_seri" />
        <result property="vigente" column="cand_vige" />
        <association property="uso" resultMap="usoCandadoMap" />
        <association property="persona" resultMap="personaMap" />
        <association property="ubicacion" resultMap="ubicacionMap" />
    </resultMap>

    <resultMap id="tagMap" type="TagTO" >
        <id property="id" column="taeq_id" />
        <result property="numero" column="taeq_nume" />
        <result property="nombre" column="taeq_nomb" />
        <result property="descripcion" column="taeq_desc" />
        <result property="energiaCero" column="taeq_enrg_cero" />
        <result property="vigente" column="taeq_vige" />
        <association property="equipo" resultMap="equipoMap" />
    </resultMap>
    
    <resultMap id="equipoMap" type="EquipoTO" >
        <id property="id" column="eqpo_id" />
        <result property="codigo" column="eqpo_codi" />
        <result property="vigente" column="eqpo_vige" />
        <association property="ubicacion" resultMap="ubicacionMap" />
    </resultMap>

    <resultMap id="equipoTagsMap" type="EquipoTagsTO" >
        <id property="id" column="eqpo_id" />
        <result property="codigo" column="eqpo_codi" />
        <result property="vigente" column="eqpo_vige" />
        <association property="ubicacion" resultMap="ubicacionMap" />
        <collection property="tags" javaType="ArrayList" ofType="TagTO" resultMap="tagMap" />
    </resultMap>
    
    <resultMap id="responsableMap" type="ResponsableTO" >
        <id property="id" column="resp_id" />
        <result property="fechaInicio" column="resp_fech_inic" />
        <result property="fechaTermino" column="resp_fech_fina" />
        <association property="persona" resultMap="personaMap" />
        <association property="empresa" resultMap="empresaMap" />
        <association property="ubicacion" resultMap="ubicacionMap" />
    </resultMap>
    
    <resultMap id="tagLibroMap" type="TagLibroTO" >
        <association property="libro" resultMap="libroBloqueoMap" />
        <result property="id" column="taeq_id" />
        <result property="numero" column="taeq_nume" />
        <result property="nombre" column="taeq_nomb" />
        <result property="descripcion" column="taeq_desc" />
        <result property="energiaCero" column="taeq_enrg_cero" />
        <result property="vigente" column="taeq_vige" />
        <association property="equipo" resultMap="equipoMap" />
    </resultMap>
    
    <resultMap id="energiaLibroMap" type="EnergiaLibroTO" >
        <association property="libro" resultMap="libroBloqueoMap" />
        <result property="id" resultMap="dval_id" />
        <result property="codigo" resultMap="dval_codi" />
        <result property="nombre" resultMap="dval_nomb" />
        <result property="vigente" resultMap="dval_vige" />
    </resultMap>

    <resultMap id="funcionBloqueoMap" type="FuncionBloqueoTO" >
        <id property="id" column="fubl_id" />
        <result property="nombre" column="fubl_nomb" />
        <result property="maximo" column="fubl_maxi" />
        <result property="vigente" column="fubl_vige" />
    </resultMap>
    
    <resultMap id="dotacionLibroMap" type="DotacionLibroTO" >
        <id property="id" column="dolc_id" />
        <result property="fechaBloqueo" column="dolc_fech_bloq" />
        <result property="fechaDesbloqueo" column="dolc_fech_desb" />
        <association property="libro" resultMap="libroBloqueoMap" />
        <association property="funcion" resultMap="funcionBloqueoMap" />
        <association property="trabajador" resultMap="trabajadorMap" />
        <association property="candado" resultMap="candadoMap" />
        <association property="autorizaBloqueo" resultMap="personaMap" columnPrefix="bloq_" />
        <association property="autorizaDesbloqueo" resultMap="personaMap" columnPrefix="desb_" />
    </resultMap>

    <resultMap id="respLibroMap" type="RespLibroTO" >
        <id property="id" column="relc_id" />
        <association property="libro" resultMap="libroBloqueoMap" />
        <association property="trabajador" resultMap="trabajadorMap" />
        <result property="fechaIngreso" column="relc_fech_ingr" />
        <result property="fechaSalida" column="relc_fech_sali" />
    </resultMap>

    <resultMap id="libroBloqueoMap" type="LibroBloqueoTO" >
        <id property="id" column="lcbl_id" />
        <result property="numero" column="lcbl_nume" />
        <result property="fecha" column="lcbl_fech" />
        <result property="cerrado" column="lcbl_cerr" />
        <result property="fechaCierre" column="lcbl_fech_cerr" />
        <association property="caja" resultMap="cajaBloqueoMap" />
    </resultMap>

    <resultMap id="libroBloqueoInfoMap" type="LibroBloqueoInfoTO" >
        <id property="id" column="lcbl_id" />
        <result property="numero" column="lcbl_nume" />
        <result property="fecha" column="lcbl_fech" />
        <result property="cerrado" column="lcbl_cerr" />
        <result property="fechaCierre" column="lcbl_fech_cerr" />
        <association property="caja" resultMap="cajaBloqueoMap" />
        <collection property="tags" javaType="ArrayList" ofType="TagLibroTO" resultMap="tagLibroMap" />
        <collection property="energias" javaType="ArrayList" ofType="EnergiaLibroTO" resultMap="energiaLibroMap" />
        <collection property="dotacion" javaType="ArrayList" ofType="DotacionLibroTO" resultMap="dotacionLibroMap" />
        <collection property="responsables" javaType="ArrayList" ofType="RespLibroTO" resultMap="respLibroMap" />
    </resultMap>

    <select id="selectUbicacion" parameterType="UbicacionTO" resultMap="ubicacionMap" >
        select a.ubic_id
              ,a.ubic_nomb
              ,a.ubic_desc
              ,a.ubic_vige
              ,b.tokn_id
        from   rcb_ubic a inner join rcb_tokn b
           on (a.ubic_id = b.ubic_id)
        <where>
            <choose>
                <when test="token != null">
                    and b.tokn_id = #{token}        	
                </when>
                <when test="id != null" >
                    and a.ubic_id = #{id}
                </when>
                <otherwise>
                    and b.tokn_id = 'X'
                </otherwise>
            </choose>
        </where>
    </select>
    
    <select id="selectCajasBloqueos" parameterType="map" resultMap="cajaBloqueoMap" >
        select a.cabl_id
              ,a.cabl_nomb
              ,a.cabl_nume
              ,a.cabl_vige
              ,b.ubic_id
              ,b.ubic_nomb
              ,b.ubic_desc
              ,b.ubic_vige
              ,d.tokn_id
              ,c.estc_id
              ,c.estc_nomb
              ,c.estc_vige
        from   rcb_caja_bloq a inner join rcb_ubic b
           on (a.ubic_id = b.ubic_id) inner join rcb_estc c
           on (b.estc_id = c.estc_id) inner join rcb_tokn d
           on (b.ubic_id = d.ubic_id)
        where  a.ubic_id = #{ubicacion.id}
        <choose>
            <when test="caja!=null and caja.id != null" >
                and a.cabl_id = #{caja.id}
            </when>
            <when test="caja!=null and caja.numero != null" >
                and a.cabl_nume = #{caja.numero}
            </when>
        </choose>
        <if test="vigencia != null" >
            and a.cabl_vige = #{vigencia}
        </if>
        
        order by b.ubic_nomb
                ,a.cabl_nume
    </select>
    
    <select id="childsCajaBloqueo" parameterType="CajaBloqueoTO" resultType="int" >
        select count(*)
        from   rcb_libr_ctrl_bloq a inner join rcb_caja_bloq b
           on (a.cabl_id = b.cabl_id) 
        <where>
            <choose>
                <when test="id != null" >
                    a.cabl_id = #{id}
                </when>
                <when test="numero != null and ubicacion != null and ubicacion.id != null" >
                        b.cabl_nume = #{numero}
                    and b.ubic_id   = #{ubicacion.id}
                </when>
            </choose>
        </where>
    </select>

    <insert id="insertCajaBloqueo" parameterType="CajaBloqueoTO" >
        <selectKey keyProperty="id" resultType="int" order="BEFORE" >
            select get_nuevo_id()
        </selectKey>
        insert into rcb_caja_bloq(cabl_id, cabl_nume, cabl_nomb, cabl_vige, ubic_id, audi_fech_crea)
            values(#{id},#{numero},#{nombre},#{vigente},#{ubicacion.id},localtimestamp)
    </insert>
    
    <update id="updateCajaBloqueo" parameterType="CajaBloqueoTO" >
        update rcb_caja_bloq set
               cabl_nume = #{numero}
              ,cabl_nomb = #{nombre}
              ,cabl_vige = #{vigente}
              ,ubic_id   = #{ubicacion.id}
              ,audi_fech_modi = localtimestamp
        where  cabl_id = #{id}
    </update>

    <delete id="deleteCajaBloqueo" parameterType="CajaBloqueoTO" >
        delete from rcb_caja_bloq
        where cabl_id   = #{id}
    </delete>
    
    <select id="selectCandados" parameterType="map" resultMap="candadoMap" >
        select a.cand_id
              ,a.cand_nume
              ,a.cand_seri
              ,a.cand_vige
              ,b.dval_id
              ,b.dval_codi
              ,b.dval_nomb
              ,b.dval_vige
              ,b.dval_domi
              ,c.pers_id
              ,c.pers_rut
              ,c.pers_nomb
              ,d.ubic_id
              ,d.ubic_nomb
              ,d.ubic_desc
              ,d.ubic_vige
              ,e.tokn_id
        from   rcb_cand a inner join rcb_domi_valo b
           on (a.dval_id_uso = b.dval_id) left join rcb_pers c
           on (a.pers_id = c.pers_id) inner join rcb_ubic d
           on (a.ubic_id = d.ubic_id) inner join rcb_tokn e
           on (d.ubic_id = e.ubic_id)
        where  a.ubic_id = #{ubicacion.id}
        <choose>
            <when test="candado!=null and candado.id!=null" >
                and a.cand_id = #{candado.id}
            </when>
            <when test="candado!=null and candado.numero!=null" >
                and a.cand_nume  = #{candado.numero}
            </when>
            <when test="serie!=null" >
                and a.cand_seri = #{serie}
            </when>
            <when test="persona!=null and persona.rut!=null" >
                c.pers_rut = #{persona.rut,typeHandler=RutTypeHandler}
            </when>
        </choose>
        <if test="vigencia != null" >
            and a.cand_vige = #{vigencia}
        </if>
        
        order by a.ubic_id
                ,a.cand_seri
    </select>    

    <select id="childsCandado" parameterType="CandadoTO" resultType="int" >
        select count(*)
        from   rcb_dota_lcbl
        where  lcbl_id = #{id}
    </select>

    <insert id="insertCandado" parameterType="CandadoTO" >
        <selectKey keyProperty="id" resultType="int" order="BEFORE" >
            select get_nuevo_id()
        </selectKey>
        insert into rcb_cand(cand_id, cand_nume, cand_seri, cand_vige, dval_id_uso, pers_id, ubic_id, audi_fech_crea)
            values(#{id},#{numero},#{serie},#{vigente},#{uso.id},#{persona.id},#{ubicacion.id},localtimestamp)
    </insert>

    <update id="updateCandado" parameterType="CandadoTO" >
        update rcb_cand set
               cand_seri   = #{serie}
              ,cand_nume   = #{numero}
              ,cand_vige   = #{vigente}
              ,dval_id_uso = #{uso.id}
              ,pers_id     = #{persona.id}
              ,ubic_id     = #{ubicacion.id}
              ,audi_fech_modi = localtimestamp
        where  cand_id = #{id}
    </update>

    <delete id="deleteCandado" parameterType="CandadoTO" >
        delete from rcb_cand
        where cand_id = #{id}
    </delete>
    
    <select id="selectPersonas" parameterType="map" resultMap="personaMap" >
        select a.pers_id
              ,a.pers_rut
              ,a.pers_nomb
        from   rcb_pers a
        <where>
            <choose>
                <when test = "persona != null and persona.id != null" >
                    a.pers_id  = #{persona.id}
                </when>
                <when test = "persona != null and persona.rut != null" >
                    a.pers_rut = #{persona.rut,typeHandler=RutTypeHandler}
                </when>
            </choose>
        </where>
        order by a.pers_rut
    </select>

    <insert id="insertPersona" parameterType="PersonaTO" >
        <selectKey keyProperty="id" resultType="int" order="BEFORE" >
            select get_nuevo_id()
        </selectKey>
        insert into rcb_pers(pers_id, pers_rut, pers_nomb, audi_fech_crea)
            values(#{id},#{rut,typeHandler=RutTypeHandler},#{nombre},localtimestamp)
    </insert>
    
    <update id="updatePersona" parameterType="PersonaTO" >
        update rcb_pers set
               pers_nomb      = #{nombre}
              ,pers_rut       = #{rut,typeHandler=RutTypeHandler}
              ,audi_fech_modi = localtimestamp
        where  pers_id = #{id}
    </update>
    
    <select id="selectTrabajadores" parameterType="map" resultMap="trabajadorMap" >
        select b.pers_id    trab_id
              ,b.pers_rut   trab_rut
              ,b.pers_nomb  trab_nomb
              ,a.trab_carg
              ,a.trab_curs_bloq
              ,a.trab_vige
              ,c.empr_id
              ,c.empr_rut
              ,c.empr_nomb
              ,c.empr_vige
        from   rcb_trab a inner join rcb_pers b
           on (a.pers_id = b.pers_id) inner join rcb_empr c
           on (a.empr_id = c.empr_id)
        <where>
        	<choose>
	            <when test = "trabajador!=null and trabajador.id!=null" >
	                b.pers_id = #{trabajador.id}
	            </when>
	            <when test = "trabajador!=null and trabajador.rut!=null" >
	                b.pers_rut = #{trabajador.rut,typeHandler=RutTypeHandler}
	            </when>
        	</choose>
        	<choose>
	            <when test = "empresa!=null and empresa.id!=null" >
	                and c.empr_id   = #{empresa.id}
	            </when>
	            <when test = "empresa!=null and empresa.rut!=null" >
	                and c.empr_rut  = #{empresa.rut,typeHandler=RutTypeHandler}
	            </when>
        	</choose>
            <if test="vigencia != null" >
                and a.trab_vige = #{vigencia}
            </if>
        </where>
        order by c.empr_rut
                ,b.pers_rut
    </select>

    <select id="childsTrabajador" parameterType="TrabajadorTO" resultType="int" >
        select sum( canti )
        from
        (
            select count(*) canti
            from   rcb_resp_lcbl a inner join rcb_pers b
               on (a.pers_id = b.pers_id)
            where  b.pers_rut = #{rut,typeHandler=RutTypeHandler}
            union all
            select count(*) canti
            from   rcb_dota_lcbl a inner join rcb_pers b
               on (a.pers_id = b.pers_id)
            where  b.pers_rut = #{rut,typeHandler=RutTypeHandler}
        ) as todo
    </select>
        
    <insert id="insertTrabajador" parameterType="TrabajadorTO" >
        insert into rcb_trab(pers_id, empr_id, trab_carg, trab_curs_bloq, trab_vige, audi_fech_crea)
            values(#{id},#{empresa.id},#{cargo},#{tieneCursoBloqueo},#{vigente},localtimestamp)
    </insert>
    
    <update id="updateTrabajador" parameterType="TrabajadorTO" >
        update rcb_trab set
               trab_carg      = #{cargo}
              ,trab_curs_bloq = #{tieneCursoBloqueo}
              ,trab_vige      = #{vigente}
        where  pers_id = #{id}
          and  empr_id = #{empresa.id}
    </update>
    
    <delete id="deleteTrabajador" parameterType="TrabajadorTO" >
        delete from rcb_trab
        where  pers_id = #{id}
          and empr_id = #{empresa.id}
    </delete>

    <select id="selectEmpresas" parameterType="map" resultMap="empresaMap" >
        select a.empr_id
              ,a.empr_rut
              ,a.empr_nomb
              ,a.empr_vige
        from   rcb_empr a
        <where>
            <choose>
                <when test="empresa != null and empresa.id != null" >
                    a.empr_id = #{empresa.id}
                </when>
                <when test="empresa != null and empresa.rut != null" >
                    a.empr_rut = #{empresa.rut,typeHandler=RutTypeHandler}
                </when>
                <when test="vigencia != null" >
                    a.empr_vige = #{vigencia}
                </when>
            </choose>
        </where>
        order by a.empr_rut
    </select>

    <select id="childsEmpresa" parameterType="EmpresaTO" resultType="int" >
        select count(*) 
        from   rcb_trab a inner join rcb_empr b
           on (a.empr_id = b.empr_id)
        where  b.empr_rut = #{rut,typeHandler=RutTypeHandler}
    </select>
    
    <insert id="insertEmpresa" parameterType="EmpresaTO" >
        <selectKey keyProperty="id" resultType="int" order="BEFORE" >
            select get_nuevo_id()
        </selectKey>
        insert into rcb_empr(empr_id, empr_rut, empr_nomb, empr_vige, audi_fech_crea)
             values(#{id},#{rut,typeHandler=RutTypeHandler},#{nombre},#{vigente},localtimestamp)
    </insert>
    
    <update id="updateEmpresa" parameterType="EmpresaTO" >
        update rcb_empr set
               empr_nomb = #{nombre}
              ,empr_rut  = #{rut,typeHandler=RutTypeHandler}
              ,empr_vige = #{vigente}
              ,audi_fech_crea = localtimestamp
        where  empr_id = #{id}
    </update>
    
    <delete id="deleteEmpresa" parameterType="EmpresaTO" >
        delete from rcb_empr
        where  empr_id = #{id}
    </delete>
    
    <select id="selectEquipos" parameterType="map" resultMap="equipoMap" >
        select a.eqpo_id
              ,a.eqpo_codi
              ,a.eqpo_vige
              ,b.ubic_id
              ,b.ubic_nomb
              ,b.ubic_vige
        from   rcb_eqpo a left join rcb_ubic b
           on (a.ubic_id = b.ubic_id)
        where  a.ubic_id = #{ubicacion.id}
        <choose>
            <when test="equipo.id != null" >
                and a.eqpo_id = #{equipo.id}
            </when>
            <when test="equipo.codigo != null" >
                and a.eqpo_codi = #{equipo.codigo}
            </when>
        </choose>            
        <if test="vigencia != null" >
            and a.eqpo_vige = #{vigencia}
        </if>
        order by a.ubic_id, a.eqpo_codi
    </select>

    <select id="childsEquipo" parameterType="EquipoTO" resultType="int" >
        select count(*) 
        from   rcb_tags_eqpo a inner join rcb_eqpo b
           on (a.eqpo_id = b.eqpo_id)
        where  b.eqpo_id = #{id}
    </select>
    
    <insert id="insertEquipo" parameterType="EquipoTO" >
        <selectKey keyProperty="id" resultType="int" order="BEFORE" >
            select get_nuevo_id()
        </selectKey>
        insert into rcb_eqpo(eqpo_id, eqpo_codi, eqpo_vige, ubic_id, audi_fech_crea)
             values(#{id},#{codigo},#{vigente},#{ubicacion.id},localtimestamp)
    </insert>
    
    <update id="updateEquipo" parameterType="EquipoTO" >
        update rcb_eqpo set
               eqpo_codi      = #{codigo}
              ,eqpo_vige      = #{vigente}
              ,ubic_id        = #{ubicacion.id}
              ,audi_fech_modi = localtimestamp 
        where  eqpo_id = #{id}
    </update>
    
    <delete id="deleteEquipo" parameterType="EquipoTO" >
        delete from rcb_eqpo
        where  eqpo_id = #{id}
    </delete>

    <select id="selectTags" parameterType="map" resultMap="tagMap" >
        select a.taeq_id
              ,a.taeq_nume
              ,a.taeq_nomb
              ,a.taeq_desc
              ,a.taeq_enrg_cero
              ,a.taeq_vige
              ,a.eqpo_id
              ,b.eqpo_codi
              ,b.eqpo_vige
              ,b.ubic_id
        from   rcb_tags_eqpo a inner join rcb_eqpo b
           on (a.eqpo_id = b.eqpo_id)
        where  b.ubic_id = #{ubicacion.id}
        <choose>
            <when test="tag!=null and tag.id != null" >
                and a.taeq_id = #{tag.id}
            </when>
            <when test="tag!=null and tag.numero!=null and equipo!=null and equipo.id!=null" >
                and a.eqpo_id   = #{equipo.id}
                and a.taeq_nume = #{tag.numero}
            </when>
            <when test="equipo!=null and equipo.id!=null" >
                and a.eqpo_id = #{equipo.id}
            </when>
            <when test="equipo!=null and equipo.codigo!=null" >
                and b.eqpo_codi = #{equipo.codigo}
            </when>
        </choose>
        <if test="vigencia != null" >
            and a.taeq_vige = #{vigencia}
        </if>
        <if test="energiaCero != null" >
            and a.taeq_enrg_cero = #{energiaCero}
        </if>

        order by a.eqpo_id, a.taeq_nume
    </select>

    <select id="childsTag" parameterType="TagTO" resultType="int" >
        select count(*) 
        from   rcb_taeq_lcbl a inner join rcb_tags_eqpo b
           on (a.taeq_id = b.taeq_id)
        where  b.taeq_nume = #{numero}
          and  b.eqpo_id   = #{equipo.id}
    </select>
    
    <insert id="insertTag" parameterType="TagTO" >
        <selectKey keyProperty="id" resultType="int" order="BEFORE" >
            select get_nuevo_id()
        </selectKey>
        insert into rcb_tags_eqpo(taeq_id, taeq_nume, taeq_nomb, taeq_desc, taeq_enrg_cero, taeq_vige, eqpo_id, audi_fech_crea)
             values(#{id},#{numero},#{nombre},#{descripcion},#{energiaCero},#{vigente},#{equipo.id},localtimestamp)
    </insert>

    <update id="updateTag" parameterType="TagTO" >
        update rcb_tags_eqpo set
               taeq_nume      = #{numero}
              ,taeq_nomb      = #{nombre}
              ,taeq_desc      = #{descripcion}
              ,taeq_enrg_cero = #{energiaCero}
              ,taeq_vige      = #{vigente}
              ,eqpo_id        = #{equipo.id}
              ,audi_fech_modi = localtimestamp 
        where  taeq_id = #{id}
    </update>

    <delete id="deleteTag" parameterType="TagTO" >
        delete from rcb_tags_eqpo
        where  taeq_id = #{id}
    </delete>

    <delete id="deleteTags" parameterType="EquipoTO" >
        delete from rcb_tags_eqpo
        where  eqpo_id = #{id}
    </delete>

    <select id="selectUsosCandado" parameterType="map" resultMap="usoCandadoMap" >
        select a.dval_id
              ,a.dval_codi
              ,a.dval_nomb
              ,a.dval_vige
        from   rcb_domi_valo a
        where  dval_domi = 'uso.candado'
        <choose>
            <when test="uso!=null and uso.id != null" >
                and a.dval_id = #{uso.id}
            </when>
            <when test="uso!=null and uso.codigo != null" >
                and a.dval_codi = #{uso.codigo}
            </when>
        </choose>
        <if test="vigencia != null" >
            and a.dval_vige = #{vigencia}
        </if>
    </select>
    
    <select id="selectResponsables" resultMap="responsableMap" >
        select a.resp_id
              ,a.resp_fech_ingr
              ,a.resp_fech_sali
              ,b.pers_id
              ,b.pers_rut
              ,b.pers_nomb
              ,b.pers_vige
              ,c.trab_carg
              ,c.trab_curs_bloq
              ,c.trab_vige
              ,d.empr_id
              ,d.empr_rut
              ,d.empr_nomb
              ,d.empr_vige
              ,e.ubic_id
              ,e.ubic_nomb
              ,e.ubiv_vige
        from   rcb_resp a inner join rcb_pers b
           on (a.pers_id = b.pers_id) inner join rcb_trab c
           on (a.pers_id = c.pers_id) inner join rcb_empr d
           on (c.pers_id = d.pers_id
           and c.empr_id = d.empr_id) inner join rcb_ubic e
           on (a.ubic_id = e.ubic_id)
        where  a.ubic_id = #{ubicacion.id}
        <choose>
            <when test="persona != null and persona.id!=null">
                and  b.pers_id = #{trabajador.id}
            </when>
            <when test="persona != null and persona.rut!=null">
                and  b.pers_rut = #{trabajador.rut}
            </when>
        </choose>
        <choose>
            <when test="empresa != null and empresa.id!=null">
                and  d.empr_id = #{empresa.id}
            </when>
            <when test="empresa != null and empresa.rut!=null">
                and  d.empr_rut = #{empresa.rut}
            </when>
        </choose>

        <if test="fechaIngreso != null" >
            and a.resp_fech_ingr = #{fechaIngreso,jdbcType=TIMESTAMP}
        </if>
        
        <if test="vigente != null">
            and a.resp_fech_fina is null
        </if>

        order by c.empr_rut, b.pers_rut, a.pers_fech_ingr
    </select>
    
    <select id="childsResponsable" parameterType="ResponsableTO" resultType="int" >
        select count(*)
        from   rcb_resp a inner join rcb_libr_ctrl_bloq b
           on (a.resp_fech_ini >= b.lcbl_fech )
        where  a.ubic_id = #{ubicacion.id}
        <choose>
            <when test="id != null" >
                a.resp_id = #{id}
            </when>
            <when test="persona != null and persona.id" >
                a.pers_id = #{persona.id}
            </when>
        </choose>
    </select>
    
    <insert id="insertResponsable" parameterType="ResponsableTO" >
        <selectKey keyProperty="id" resultType="int" order="BEFORE" >
            select get_nuevo_id()
        </selectKey>
        insert into rcb_resp(resp_id, pers_id, empr_id, ubic_id, resp_fech_ingr, resp_fech_sali)
             values(#{id},#{persona.id},#{empresa.id},#{ubicacion.id},#{fechaIngreso,jdbcType=TIMESTAMP},#{fechaSalida,jdbcType=TIMESTAMP});
    </insert>

    <update id="updateResponsable" parameterType="ResponsableTO" >
        update rcp_resp set
               perd_id = #{persona.id}
              ,empr_id = #{empresa.id}
              ,ubic_id = #{ubicacion.id}
              ,resp_fech_inic = #{fechaInicio,jdbcType=TIMESTAMP}
              ,resp_fech_fina = #{fechaTermino,jdbcType=TIMESTAMP}
        where  resp_id = #{id}
    </update>

    <delete id="deleteResponsable" parameterType="ResponsableTO" >
        delete from rcb_resp
        where resp_id = #{id}
    </delete>
    
    <select id="selectLibros" parameterType="map" resultMap="libroBloqueoMap" >
        select a.lcbl_id
              ,a.lcbl_nume
              ,a.lcbl_fech
              ,a.lcbl_cerr
              ,a.lcbl_fech_cerr
              ,b.cabl_id
              ,b.cabl_nume
              ,b.cabl_nomb
              ,b.cabl_vige
              ,c.ubic_id
              ,c.ubic_nomb
              ,c.ubic_desc
              ,c.ubic_vige 
        from   rcb_libr_ctrl_bloq a inner join rcb_caja_bloq b
           on (a.cabl_id = b.cabl_id) inner join rcb_ubic c
           on (b.ubic_id = c.ubic_id) 
        where  c.ubic_id = #{ubicacion.id}
        <choose>
            <if test="libro != null and libro.id!=null" >
                and  a.lcbl_id   = #{libro.id}                
            </if>
            <if test="libro != null and libro.numero!=null" >
                and  b.lcbl_nume = #{libro.numero}                
            </if>
        </choose>
        <choose>
            <if test="caja != null and caja.id!=null" >
                and  b.cabl_id = #{caja.id}                
            </if>
            <if test="caja != null and caja.numero!=null" >
                and  b.cabl_nume = #{caja.numero}                
            </if>
        </choose>
        <if test="libroCerrado != null" >
            and a.lcbl_cerr = true
        </if>
        <if test="fechaLibro != null" >
            and a.lcbl_fech >= #{fechaLibro,jdbcType=TIMESTAMP}
        </if>

        order by b.ubic_id, b.cabl_nume, a.lcbl_nume
    </select>
    
    <select id="childsLibro" parameterType="LibroBloqueoTO" resultType="int" >
        select sum(*)
        from
        (
            select count(*)
            from   rcb_taeq_lcbl a
            where  a.lcbl_id = #{id}
            union all
            select count(*)
            from   rcb_enrg_lcbl a
            where  a.lcbl_id = #{id}
            union all
            select count(*)
            from   rcb_dota_lcbl a
            where  a.lcbl_id = #{id}
            select count(*)
            from   rcb_resp_lcbl a
            where  a.lcbl_id = #{id}
        ) as todo
    </select>

    <insert id="insertLibro" parameterType="LibroBloqueoTO" >
        <selectKey keyProperty="id" resultType="int" order="BEFORE" >
            select get_nuevo_id()
        </selectKey>
        insert into rcb_libr_ctrl_bloq(lcbl_id, lcbl_nume, lcbl_fech, lcbl_cerr, lcbl_fech_cerr, cabl_id, audi_fech_crea )
             values(#{id},#{numero},#{fecha},#{cerrado},#{fechaCierre,jdbcType=TIMESTAMP},#{caja.id},localtimestamp)
    </insert>
    
    <update id="updateLibro" parameterType="LibroBloqueoTO" >
        update rcb_libr_ctrl_bloq set
               lcbl_nume      = #{numero}
              ,lcbl_fech      = #{fecha}
              ,lcbl_cerr      = #{cerrado}
              ,lcbl_fech_cerr = #{fechaCierre,jdbcType=TIMESTAMP}
              ,cabl_id        = #{caja.id}
              ,audi_fech_modi = localtimestamp
        where  lcbl_id = #{id}
    </update>
    
    <delete id="deleteLibro" parameterType="LibroBloqueoTO" >
        delete from rcb_libr_ctrl_bloq 
        where  lcbl_id = #{id}
    </delete>
    
    <select id="selectTagsLibro" parameterType="map" resultMap="tagLibroMap" >
        select a.lcbl_id
              ,a.lcbl_nume
              ,a.lcbl_fech
              ,a.lcbl_cerr
              ,a.lcbl_fech_cerr
              ,b.cabl_id
              ,b.cabl_nume
              ,b.cabl_nomb
              ,b.cabl_vige
              ,b.ubic_id
              ,d.taeq_id
              ,d.taeq_nume
              ,d.taeq_nomb
              ,d.taeq_desc
              ,d.taeq_enrg_cero
              ,d.taeq_vige
              ,e.eqpo_id
              ,e.eqpo_codi
              ,e.eqpo_vige
        from   rcb_libr_ctrl_bloq a   inner join rcb_caja_bloq b
           on (a.cabl_id = b.cabl_id) inner join rcb_taeq_lcbl c
           on (a.lcbl_id = c.lcbl_id) inner join rcb_tags_eqpo d
           on (c.taeq_id = d.taeq_id) inner join rcb_eqpo      e
           on (e.eqpo_id = e.eqpo_id)
        where  a.lcbl_id = #{libro.id}
        <choose>
            <when test="tag!=null and tag.id!=null" >
                and d.taeq_id = #{tag.id}
            </when>
            <when test="tag!=null and tag.numero!=null" >
                and d.taeq_nume = #{tag.numero}
            </when>
        </choose>
            
        order by e.eqpo_codi, d.taeq_nume
    </select>
    
    <insert id="insertTagLibro" parameterType="TagLibroTO" >
        <selectKey keyProperty="id" resultType="int" order="BEFORE" >
            select get_nuevo_id()
        </selectKey>
        insert into rcb_taeq_lcbl(lcbl_id, taeq_id, audi_fech_crea )
             values(#{libro.id},#{id},localtimestamp)
    </insert>

    <delete id="deleteTagLibro" parameterType="TagLibroTO" >
        delete from rcb_taeq_lcbl
        where  lcbl_id = #{libro.id}
          and  taeq_id = #{id}
    </delete>

    <select id="selectEnergiasLibro" parameterType="map" resultMap="energiaLibroMap" >
        select a.lcbl_id
              ,a.lcbl_nume
              ,a.lcbl_fech
              ,a.lcbl_cerr
              ,a.lcbl_fech_cerr
              ,b.cabl_id
              ,b.cabl_nume
              ,b.cabl_nomb
              ,b.cabl_vige
              ,b.ubic_id
              ,d.dval_id
              ,d.dval_codi
              ,d.dval_nomb
              ,d.dval_vige
        from   rcb_libr_ctrl_bloq a   inner join rcb_caja_bloq b
           on (a.cabl_id = b.cabl_id) inner join rcb_enrg_lcbl c
           on (a.lcbl_id = c.lcbl_id) inner join rcb_domi_valo d
           on (c.dval_id_item = d.dval_id)
        where  a.lcbl_id = #{id}
        <choose>
            <when test="energia!=null and energia.id!=null" >
                and d.dval_id = #{energia.id}
            </when>
            <when test="energia!=null and energia.codigo!=null" >
                and d.dval_codi = #e{energia.codigo}
            </when>
        </choose>
        order by d.dval_domi, d.dval_codi
    </select>
    
    <insert id="insertEnergiaLibro" parameterType="EnergiaLibroTO" >
        <selectKey keyProperty="id" resultType="int" order="BEFORE" >
            select get_nuevo_id()
        </selectKey>
        insert into rcb_enrg_lcbl(lcbl_id, dval_id_item, audi_fech_crea )
             values(#{libro.id},#{id},localtimestamp)
    </insert>
    
    <delete id="deleteEnergiaLibro" parameterType="EnergiaLibroTo" >
        delete from rcb_enrg_lcbl
        where  lcbl_id = #{libro.id}
          and  dval_id_item = #{id}
    </delete>

    <select id="selectDotacionLibro" parameterType="LibroBloqueoTO" resultMap="dotacionLibroMap" >
        select a.lcbl_id
              ,a.lcbl_nume
              ,a.lcbl_fech
              ,a.lcbl_cerr
              ,a.lcbl_fech_cerr
              ,b.cabl_id
              ,b.cabl_nume
              ,b.cabl_nomb
              ,b.cabl_vige
              ,b.ubic_id
              ,c.dolc_id
              ,c.dolc_fech_bloq
              ,c.dolc_fech_desb
              ,d.fubl_id
              ,d.fubl_nomb
              ,d.fubl_maxi
              ,d.fubl_vige
              ,g.pers_id         trab_id
              ,g.pers_rut        trab_rut 
              ,g.pers_nomb       trab_nomb
              ,e.trab_carg
              ,e.trab_curs_bloq
              ,e.trab_vige
              ,f.empr_id
              ,f.empr_rut
              ,f.empr_nomb
              ,f.empr_vige
              ,j.cand_id
              ,j.cand_nume
              ,j.cand_seri
              ,j.cand_vige
              ,j.dval_id_uso
              ,h.pers_id          bloq_pers_id
              ,h.pers_rut         bloq_pers_rut
              ,h.pers_nomb        bloq_pers_nomb
              ,i.pers_id          desb_pers_id
              ,i.pers_rut         desb_pers_rut
              ,i.pers_nomb        desb_pers_nomb
        from   rcb_libr_ctrl_bloq a   inner join rcb_caja_bloq b
           on (a.cabl_id = b.cabl_id) inner join rcb_dota_lcbl c
           on (a.lcbl_id = c.lcbl_id) inner join rcb_func_bloq d
           on (c.fubl_id = d.fubl_id) inner join rcb_trab      e
           on (c.pers_id = e.pers_id
           and c.empr_id = e.empr_id) inner join rcb_empr      f
           on (e.empr_id = f.empr_id) inner join rcb_pers      g
           on (e.pers_id = g.pers_id) left  join rcb_pers      h
           on (c.pers_id_bloq = h.pers_id) left join rcb_pers  i
           on (c.pers_id_desb = i.pers_id) inner join rcb_cand j
           on (c.cand_id = j.cand_id)
        where  a.lcbl_id = #{id}
        <choose>
            <when test="dotacion!=null and dotacion.id!=null" >
                and c.dolc_id = #{dotacion.id}
            </when>
            <when test="trabajador!=null and trabajador.id!=null" >
                and g.pers_id = #{trabajador.id}
            </when>
            <when test="trabajador!=null and trabajador.rut!=null" >
                and g.pers_id = #{trabajador.rut,typeHandler=RutTypeHandler}
            </when>
        </choose>
        order by g.rut
    </select>

    <insert id="insertDotacionLibro" parameterType="DotacionLibroTO" >
        <selectKey keyProperty="id" resultType="int" order="BEFORE" >
            select get_nuevo_id()
        </selectKey>
        insert into rcb_dota_lcbl(dolc_id, lcbl_id, fubl_id, empr_id, pers_id, cand_id, pers_id_bloq, 
                                  pers_id_desb, dolc_fech_bloq, dolc_fech_desb, audi_fech_crea)
            values(#{id},
                   #{libro.id},
                   #{funcion.id},
                   #{trabajador.empresa.id},
                   #{trabajador.id},
                   #{candado.id},
                   #{autorizaBloqueo.id},
                   #{autorizaDesbloqueo.id},
                   #{fechaBloqueo,jdbcType=TIMESTAMP},
                   #{fechaDesbloqueo,jdbcType=TIMESTAMP},localtimestamp)
    </insert>

    <update id="updateDotacionLibro" parameterType="DotacionLibroTO" >
        update rcb_dota_lcbl set
               fubl_id        = #{funcion.id}  
              ,empr_id        = #{trabajador.empresa.id} 
              ,pers_id        = #{trabajador.id}
              ,cand_id        = #{candado.id}
              ,pers_id_bloq   = #{autorizaBloqueo.id}
              ,pers_id_desb   = #{autorizaDesbloqueo.id} 
              ,dolc_fech_bloq = #{fechaBloqueo,jdbcType=TIMESTAMP}  
              ,dolc_fech_desb = #{fechaDesbloqueo,jdbcType=TIMESTAMP}
              ,audi_fech_modi = localtimestamp
        where  dolc_id = {id}
    </update>
    
    <delete id="deleteDotacionLibro" parameterType="DotacionLibroTO" >
        delete from rcb_dota_lcbl
        where  dolc_id = #{id}
    </delete>

    <select id="selectRespLibro" parameterType="map" resultMap="respLibroMap" >
        select a.lcbl_id
              ,a.lcbl_nume
              ,a.lcbl_fech
              ,a.lcbl_cerr
              ,a.lcbl_fech_cerr
              ,b.cabl_id
              ,b.cabl_nume
              ,b.cabl_nomb
              ,b.cabl_vige
              ,b.ubic_id
              ,c.relc_id
              ,c.relc_fech_ingr
              ,c.relc_fech_sali
              ,f.pers_id         trab_id
              ,f.pers_rut        trab_rut
              ,f.pers_nomb       trab_nomb
              ,d.trab_carg
              ,d.trab_curs_bloq
              ,d.trab_vige
              ,e.empr_id        
              ,e.empr_rut
              ,e.empr_nomb
              ,e.empr_vige
        from   rcb_libr_ctrl_bloq a   inner join rcb_caja_bloq b
           on (a.cabl_id = b.cabl_id) inner join rcb_resp_lcbl c
           on (c.lcbl_id = c.lcbl_id) inner join rcb_trab d
           on (c.pers_id = d.pers_id
           and d.empr_id = d.empr_id) inner join rcb_empr e
           on (d.empr_id = e.empr_id) inner join rcb_pers f
           on (d.pers_id = f.pers_id) 
        where  a.lcbl_id = #{libro.id}

        <choose>
            <when test="responsable!=null and responsable.id!=null" >
                and c.relc_id = #{responsable.id}
            </when>
            <when test="trabajador!=null and trabajador.id!=null" >
                and f.pers_id = #{trabajador.id}
                and c.relc_fech_ingr = #{responsable.fechaIngreso,jdbcType=TIMESTAMP}
            </when>
            <when test="trabajador!=null and trabajador.rut!=null" >
                and f.pers_id = #{trabajador.rut,typeHandler=RutTypeHandler}
                and c.relc_fech_ingr = #{responsable.fechaIngreso,jdbcType=TIMESTAMP}
            </when>
        </choose>

        <if test="vigente!=null" >
            and c.relc_fech_sali is null
        </if>

        order by c.relc_fech_ingr, f.pers_rut
    </select>
    
    <insert id="insertRespLibro" parameterType="RespLibroTO" >
        <selectKey keyProperty="id" resultType="int" order="BEFORE" >
            select get_nuevo_id()
        </selectKey>
        
        insert into rcb_resp_lcbl(relc_id,lcbl_id,pers_id,empr_id,relc_fech_ingr,relc_fech_sali,audi_fech_crea)
            values(#{id},#{libro.id},#{trabajador.id},#{trabajador.empresa.id},
                   #{fechaIngreso,jdbcType=TIMESTAMP},#{fechaSalida,jdbcType=TIMESTAMP},localtimestamp)
    </insert>
    
    <update id="updateRespLibro" parameterType="RespLibroTO" >
        update rcb_resp_lcbl set
               relc_fech_sali = #{fechaSalida}
              ,audi_fech_modi = localtimestamp
        where  relc_id = #{id}
    </update>
</mapper>