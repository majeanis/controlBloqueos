<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cl.cerrocolorado.recob.po.map.RecobMap">

    <resultMap id="estacionMap" type="EstacionTO" >
        <id property="id" column="estc_id" />
        <result property="nombre" column="estc_nomb" />
        <result property="vigente" column="estc_vige" />
    </resultMap>

    <resultMap id="ubicacionMap" type="UbicacionTO" >
        <id property="id" column="ubic_id" />
        <result property="nombre" column="ubic_nomb" />
        <result property="descripcion" column="ubic_desc" />
        <result property="vigente" column="ubic_vige" />
        <association property="estacion" resultMap="estacionMap" />
    </resultMap>
    
    <resultMap id="cajaBloqueoMap" type="CajaBloqueoTO" >
        <id property="id" column="cabl_id" />
        <result property="numero" column="cabl_nume" />
        <result property="nombre" column="cabl_nomb" />
        <result property="vigente" column="cabl_vige" />
        <association property="ubicacion" resultMap="ubicacionMap" />
    </resultMap> 
    
    <select id="selectCajaBloqueo" parameterType="map" resultType="CajaBloqueoTO" resultMap="cajaBloqueoMap" >
        select a.cabl_id
              ,a.cabl_nomb
              ,a.cabl_nume
              ,a.cabl_vige
              ,b.ubic_id
              ,b.ubic_nomb
              ,b.ubic_desc
              ,b.ubic_vige
              ,c.estc_id
              ,c.estc_nomb
              ,c.estc_vige
        from   rcb_caja_bloq a inner join rcb_ubic b
           on (a.ubic_id = b.ubic_id) inner join rcb_estc c
           on (b.estc_id = c.estc_id)
        where  a.cabl_id = #{cajaId}
    </select>
    
    <insert id="insertCajaBloqueo" parameterType="CajaBloqueoTO" >
        <selectKey keyProperty="id" resultType="int" order="BEFORE" >
            select get_nuevo_id()
        </selectKey>
        insert into rcb_caja_bloq(cabl_id, cabl_nume, cabl_nomb, cabl_vige, ubic_id, audi_fech_crea)
            values(#{id},#{numero},#{nombre},#{vigente},#{ubicacion.id},localtimestamp)
    </insert>
    
    <update id="updateCajaBloqueo" parameterType="CajaBloqueoTO" >
        update rcb_caja_bloq set
               cabl_nume = #{numero}
              ,cabl_nomb = #{nombre}
              ,cabl_vige = #{vigente}
              ,ubic_id   = #{ubicacion.id}
              ,audi_fech_modi = localtimestamp
        where  cabl_id = #{id}
    </update>
</mapper>